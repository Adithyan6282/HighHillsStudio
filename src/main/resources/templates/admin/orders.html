<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Admin Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <!-- ✅ CSRF Meta Tags -->
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">

  <style>
    body { font-family: Arial, sans-serif; background-color: #fff; }

  </style>
</head>
<body>
<!--<header>-->
<!--  HIGH HILLS <span>STUDIO</span>-->
<!--</header>-->

<div class="container my-5">
  <h3>Orders Management</h3>

  <!-- Search, Filter & Sort Form -->
  <form class="row g-3 mb-3" th:action="@{/admin/orders}" method="get">
    <!-- Search -->
    <div class="col-auto">
      <input type="text" name="keyword" class="form-control" placeholder="Search..." th:value="${keyword}">
    </div>

    <!-- Status Filter -->
    <div class="col-auto">
      <select name="statusFilter" class="form-select">
        <option value="">All Status</option>
        <option value="PLACED" th:selected="${statusFilter=='PLACED'}">PLACED</option>
        <option value="SHIPPED" th:selected="${statusFilter=='SHIPPED'}">SHIPPED</option>
        <option value="OUT_FOR_DELIVERY" th:selected="${statusFilter=='OUT_FOR_DELIVERY'}">OUT_FOR_DELIVERY</option>
        <option value="DELIVERED" th:selected="${statusFilter=='DELIVERED'}">DELIVERED</option>
        <option value="CANCELED" th:selected="${statusFilter=='CANCELED'}">CANCELED</option>
        <option value="RETURN_REQUESTED" th:selected="${statusFilter=='RETURN_REQUESTED'}">RETURN_REQUESTED</option>
        <option value="RETURN_CONFIRMED" th:selected="${statusFilter=='RETURN_CONFIRMED'}">RETURN_CONFIRMED</option>
      </select>
    </div>

    <!-- Sort Field -->
    <div class="col-auto">
      <select name="sortField" class="form-select">
        <option value="placedAt" th:selected="${sortField=='placedAt'}">Date</option>
        <option value="orderCode" th:selected="${sortField=='orderCode'}">Order ID</option>
        <option value="totalAmount" th:selected="${sortField=='totalAmount'}">Total Amount</option>
      </select>
    </div>

    <!-- Sort Direction -->
    <div class="col-auto">
      <select name="sortDir" class="form-select">
        <option value="asc" th:selected="${sortDir=='asc'}">Ascending</option>
        <option value="desc" th:selected="${sortDir=='desc'}">Descending</option>
      </select>
    </div>

    <!-- Submit -->
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">Apply</button>
      <a th:href="@{/admin/orders}" class="btn btn-secondary">Clear</a>
    </div>
  </form>


  <!-- Orders Table -->
  <table class="table table-bordered table-hover mt-3">
    <thead class="table-light">
    <tr>
      <th>
        <a th:href="@{/admin/orders(sortField='orderCode', sortDir=${sortField=='orderCode' ? reverseSortDir : 'asc'}, keyword=${keyword})}">Order ID</a>
      </th>
      <th>
        <a th:href="@{/admin/orders(sortField='placedAt', sortDir=${sortField=='placedAt' ? reverseSortDir : 'desc'}, keyword=${keyword})}">Date</a>
      </th>
      <th>User Name</th>
      <th>User Email</th>
      <th>Total Amount</th>
      <th>Status</th>
<!--      <th>Actions</th>-->
    </tr>
    </thead>
    <tbody>
    <tr th:each="order : ${orders}">
      <td th:text="${order.orderCode}"></td>
      <td th:text="${#temporals.format(order.placedAt,'dd-MM-yyyy HH:mm')}"></td>
      <td th:text="${order.userName}"></td>
      <td th:text="${order.userEmail}"></td>
      <td>₹<span th:text="${order.totalAmount}"></span></td>
      <td>



        <select class="form-select form-select-sm order-status" th:data-ordercode="${order.orderCode}">
          <option value="PLACED" th:selected="${order.status=='PLACED'}">PLACED</option>
          <option value="SHIPPED" th:selected="${order.status=='SHIPPED'}">SHIPPED</option>
          <option value="OUT_FOR_DELIVERY" th:selected="${order.status=='OUT_FOR_DELIVERY'}">OUT_FOR_DELIVERY</option>
          <option value="DELIVERED" th:selected="${order.status=='DELIVERED'}">DELIVERED</option>
          <option value="CANCELED" th:selected="${order.status=='CANCELED'}">CANCELED</option>
          <option value="RETURN_REQUESTED" th:selected="${order.status=='RETURN_REQUESTED'}">RETURN_REQUESTED</option>
          <option value="RETURN_CONFIRMED" th:selected="${order.status=='RETURN_CONFIRMED'}">RETURN_CONFIRMED</option>
        </select>
      </td>
<!--      <td>-->
<!--        <a th:href="@{'/admin/orders/' + ${order.orderCode}}" class="btn btn-sm btn-primary">View</a>-->
<!--      </td>-->
    </tr>
    </tbody>
  </table>

  <!-- Pagination -->
  <nav aria-label="Page navigation">
    <ul class="pagination">
      <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
        <a class="page-link" th:href="@{/admin/orders(page=${currentPage-1}, keyword=${keyword}, sortField=${sortField}, sortDir=${sortDir})}">Previous</a>
      </li>
      <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages-1)}" th:classappend="${i == currentPage} ? 'active'">
        <a class="page-link" th:href="@{/admin/orders(page=${i}, keyword=${keyword}, sortField=${sortField}, sortDir=${sortDir})}" th:text="${i+1}">1</a>
      </li>
      <li class="page-item" th:classappend="${currentPage == totalPages-1} ? 'disabled'">
        <a class="page-link" th:href="@{/admin/orders(page=${currentPage+1}, keyword=${keyword}, sortField=${sortField}, sortDir=${sortDir})}">Next</a>
      </li>
    </ul>
  </nav>
</div>

<script>
  $(document).ready(function() {

      // ✅ Get CSRF token and header name from meta tags
      const token = $("meta[name='_csrf']").attr("content");
      const header = $("meta[name='_csrf_header']").attr("content");

      // ✅ Automatically attach CSRF token to every AJAX request
      $(document).ajaxSend(function(e, xhr, options) {
          xhr.setRequestHeader(header, token);
      });

      // ✅ Handle order status change
      $('.order-status').change(function() {
          let orderCode = $(this).data('ordercode');
          let newStatus = $(this).val();

          $.ajax({
              url: '/admin/orders/update-status',
              type: 'POST',
              data: {
                  orderCode: orderCode,
                  status: newStatus
              },
              success: function(response) {
                  alert(response);
              },
              error: function(err) {
                  alert('Failed to update status');
              }
          });
      });
  });
</script>
</body>
</html>





