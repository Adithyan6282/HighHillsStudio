<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Order Details - HighHills Studio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="d-flex flex-column min-vh-100">

<!-- HEADER -->
<div th:replace="user/fragments :: mainHeader"></div>

<main class="flex-grow-1">
  <div class="container my-5">
    <h3 class="mb-4 fw-semibold">Order Details</h3>

    <!-- ORDER INFO -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <p><strong>Order Code:</strong> <span th:text="${order.orderCode}"></span></p>
        <p><strong>Status:</strong> <span id="orderStatus" class="fw-bold" th:text="${order.status}"></span></p>
        <p><strong>Total Amount:</strong> ₹<span th:text="${order.totalAmount}"></span></p>
<!--        <p><strong>Total Amount:</strong> ₹<span th:text="${order.finalAmount}"></span></p>-->

      </div>
    </div>

    <!-- ORDER ITEMS -->
    <h5 class="mb-3">Items in this Order</h5>
    <div th:each="item : ${order.items}" class="card mb-3 shadow-sm">
      <div class="card-body d-flex align-items-center justify-content-between">

        <!-- PRODUCT IMAGE -->
        <div class="me-3">
          <img th:if="${item.imageUrl != null}"
               th:src="@{${item.imageUrl}}"
               alt="Product Image"
               class="img-thumbnail"
               style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
        </div>

        <!-- PRODUCT DETAILS -->
        <div class="flex-grow-1">
          <h6 class="mb-1" th:text="${item.productName}"></h6>
          <p class="mb-1 text-muted small">Qty: <span th:text="${item.quantity}"></span></p>
          <p class="mb-0 fw-semibold">
            ₹<span th:text="${item.price}"></span> ×
            <span th:text="${item.quantity}"></span> =
            ₹<span th:text="${item.totalPrice}"></span>
          </p>
        </div>
      </div>
    </div>

    <!-- ORDER SUMMARY -->
    <div class="card mt-4 shadow-sm">
      <div class="card-body">
        <h6 class="fw-semibold mb-2">Order Summary</h6>
        <h5>Total: ₹<span th:text="${order.totalAmount}"></span></h5>
      </div>
    </div>

    <!-- SHIPPING ADDRESS -->
<!--    <div class="card mt-4 shadow-sm" th:if="${order.address != null}">-->
<!--      <div class="card-body">-->
<!--        <h6 class="fw-semibold">Shipping Address</h6>-->
<!--        <p class="mb-0 fw-bold" th:text="${order.address.fullName}"></p>-->
<!--        <p class="mb-0" th:text="${order.address.street + ', ' + order.address.city}"></p>-->
<!--        <p class="mb-0">-->
<!--          <span th:text="${order.address.state}"></span> - -->
<!--          <span th:text="${order.address.pincode}"></span>-->
<!--        </p>-->
<!--        <p>Phone: <span th:text="${order.address.phone}"></span></p>-->
<!--      </div>-->
<!--    </div>-->


    <div class="card mt-4 shadow-sm" th:if="${order.address != null}">
      <div class="card-body">
        <h6 class="fw-semibold">Shipping Address</h6>

        <!-- Customer Name -->
        <p class="mb-0 fw-bold" th:text="${order.address.user.fullName}"></p>

        <!-- Address Lines -->
        <p class="mb-0">
          <span th:text="${order.address.line1}"></span><br>
          <span th:if="${order.address.line2 != null}" th:text="${order.address.line2}"></span>
        </p>

        <!-- City, State, Pincode -->
        <p class="mb-0">
          <span th:text="${order.address.city}"></span>,
          <span th:text="${order.address.state}"></span> -
          <span th:text="${order.address.pincode}"></span>
        </p>

        <!-- Country -->
        <p class="mb-0" th:text="${order.address.country}"></p>

        <!-- Phone -->
        <p>Phone: <span th:text="${order.address.phone}"></span></p>
      </div>
    </div>


    <!-- ACTION BUTTONS -->
    <div class="mt-4 d-flex flex-wrap align-items-center gap-2">
      <a id="downloadInvoiceBtn"
         class="btn btn-success"
         th:href="@{'/user/profile/order/invoice/' + ${order.orderCode}}"
         target="_blank">
        Download Invoice (PDF)
      </a>

      <!-- Cancel -->
      <button th:if="${order.status == 'PLACED'}"
              id="cancelOrderBtn"
              class="btn btn-danger">Cancel Order</button>

      <!-- Return -->
      <button th:if="${order.status == 'DELIVERED'}"
              id="returnOrderBtn"
              class="btn btn-warning">Return Order</button>

      <a href="/user/profile/orders" class="btn btn-secondary ms-auto">Back to Orders</a>
    </div>

    <input type="hidden" id="orderCodeInput" th:value="${order.orderCode}" />
  </div>
</main>



<!-- Return Reason Modal -->
<div class="modal fade" id="returnReasonModal" tabindex="-1" aria-labelledby="returnReasonModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="returnReasonModalLabel">Return Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <label for="returnReasonInput" class="form-label">Please provide a reason for return (mandatory):</label>
        <textarea id="returnReasonInput" class="form-control" rows="3" placeholder="Enter reason"></textarea>
        <div id="returnReasonError" class="text-danger mt-1" style="display:none;">Reason is required!</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="submitReturnReasonBtn" class="btn btn-warning">Submit Return</button>
      </div>
    </div>
  </div>
</div>





<!-- FOOTER -->
<div th:replace="user/fragments :: mainFooter"></div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>


  document.addEventListener('DOMContentLoaded', () => {
    const orderCode = document.getElementById('orderCodeInput')?.value;
    const cancelBtn = document.getElementById('cancelOrderBtn');
    const returnBtn = document.getElementById('returnOrderBtn');
    const statusEl = document.getElementById('orderStatus');

    // Modal elements
    const modalEl = document.getElementById('returnReasonModal');
    const modal = new bootstrap.Modal(modalEl);
    const reasonInput = document.getElementById('returnReasonInput');
    const submitBtn = document.getElementById('submitReturnReasonBtn');
    const errorEl = document.getElementById('returnReasonError');

    // Cancel order
    if (cancelBtn) {
        cancelBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to cancel this order?')) return;
            const res = await fetch(`/user/profile/order/cancel?orderCode=${orderCode}`, { method: 'POST' });
            const result = await res.text();
            if (result === 'SUCCESS') {
                alert('Order canceled successfully!');
                statusEl.textContent = 'CANCELED';
                cancelBtn.remove();
            } else {
                alert('Unable to cancel the order.');
            }
        });
    }

    // Show modal when Return button is clicked
    if (returnBtn) {
        returnBtn.addEventListener('click', () => {
            reasonInput.value = '';
            errorEl.style.display = 'none';
            modal.show();
        });
    }

    // Submit return reason
    submitBtn.addEventListener('click', async () => {
        const reason = reasonInput.value.trim();
        if (!reason) {
            errorEl.style.display = 'block';
            return;
        }

        const res = await fetch(`/user/profile/order/return?orderCode=${orderCode}&reason=${encodeURIComponent(reason)}`, { method: 'POST' });
        const result = await res.text();

        if (result === 'SUCCESS') {
            alert('Return request submitted successfully!');
            statusEl.textContent = 'RETURN_REQUESTED';
            if (returnBtn) returnBtn.remove();
            modal.hide();
        } else {
            alert('Unable to submit return request.');
        }
    });
});

</script>

</body>
</html>





