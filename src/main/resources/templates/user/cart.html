<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>My Cart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="d-flex flex-column min-vh-100">

<!-- Header Fragment -->
<div th:replace="user/fragments :: mainHeader"></div>
<main class="flex-grow-1">
<div class="container mt-4">
    <h2>My Cart</h2>
    <div id="cart-items">
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody id="cart-body">
            <!-- Cart items will be rendered here dynamically -->
            </tbody>
        </table>
        <button class="btn btn-danger" id="clear-cart">Clear Cart</button>
        <a th:href="@{/checkout}" class="btn btn-success" id="checkout-btn">Proceed to Checkout</a>
    </div>
</div>
</main>

<!-- Footer Fragment -->
<div th:replace="user/fragments :: footer"></div>

<script>
    // Fetch cart items and render table
     async function loadCart() {
         const response = await fetch('/cart/items');
         const cart = await response.json();
         const tbody = document.getElementById('cart-body');
         tbody.innerHTML = '';

         if (!cart.items || cart.items.length === 0) {
             tbody.innerHTML = '<tr><td colspan="5" class="text-center">Your cart is empty</td></tr>';
             updateCartBadge(0);  // Update badge when empty
             return;
         }

         cart.items.forEach(item => {
             const row = document.createElement('tr');
    const maxQty = 5;
    const availableStock = item.availableStock || 0;
    const isOutOfStock = availableStock <= 0;
    const disablePlus = item.quantity >= maxQty || item.quantity >= availableStock;

    row.innerHTML = `
        <td>${item.productName}
            ${isOutOfStock ? '<span class="badge bg-danger ms-2">Out of Stock</span>' : ''}
        </td>
        <td>${item.price}</td>
        <td>
            <button class="btn btn-sm btn-outline-secondary"
                    onclick="decrementQuantity(${item.productId}, '${item.fitSize}')"
                    ${isOutOfStock ? 'disabled' : ''}>-</button>
            <span id="qty-${item.productId}-${item.fitSize}">${item.quantity}</span>
            <button class="btn btn-sm btn-outline-secondary"
                    onclick="incrementQuantity(${item.productId}, '${item.fitSize}')"
                    ${disablePlus || isOutOfStock ? 'disabled' : ''}>+</button>
        </td>
        <td>${item.total}</td>
        <td>
            <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.productId})">Remove</button>
        </td>
    `;
    tbody.appendChild(row);
         });

         // Update cart badge after rendering
         updateCartBadge(cart.items.length);
     }

     // Remove product from cart
     async function removeFromCart(productId) {
         const response = await fetch(`/cart/remove/${productId}`, { method: 'POST' });
         const data = await response.json();
         alert(data.message);
         loadCart();
     }

     // Clear entire cart
     document.getElementById('clear-cart').addEventListener('click', async () => {
         const response = await fetch('/cart/clear', { method: 'POST' });
         const data = await response.json();
         alert(data.message);
         loadCart();
     });

     // Update cart badge in header
     async function updateCartBadge(count) {
         const badge = document.getElementById('cart-badge');
         if (badge) {
             badge.textContent = count !== undefined ? count : 0;
         }
     }


    // Increment quantity
    async function incrementQuantity(productId, size) {
        const response = await fetch(`/cart/increment?productId=${productId}&size=${size}`, {
            method: 'POST'
        });
        const data = await response.json();
        alert(data.message);
        loadCart(); // reload cart items
    }

    // Decrement quantity
    async function decrementQuantity(productId, size) {
        const response = await fetch(`/cart/decrement?productId=${productId}&size=${size}`, {
            method: 'POST'
        });
        const data = await response.json();
        alert(data.message);
        loadCart(); // reload cart items
    }


     // Initial load
     loadCart();
</script>

</body>
</html>




